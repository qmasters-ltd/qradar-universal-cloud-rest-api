<Workflow name="Qmasters Atlassian workflow for QRadar" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2">
    <Parameters>
        <Parameter name="identifier" label="Identifier" required="true" default="Atlassian-AuditLogs" />
        <Parameter name="orgID" label="Organization ID" required="true" />
        <Parameter name="apiToken" label="API Token" required="true" secret="true" />
        <Parameter name="timeZone" label="Time Zone" required="false" default="UTC" />
        <Parameter name="startTime" label="Start Time" required="false" default="7" />
        <Parameter name="eventsPerFetch" label="Events Per Fetch" default="100" />
    </Parameters>

    <Actions>
        <!-- Clear the log source status before a new workflow run starts -->
        <ClearStatus />
            
        <!-- Initialize the last updated time filter for the first run. -->
        <Initialize path="/bookmark" value="${time() - /startTime * 86400 * 1000}" />

        <!-- Set the first page number -->
        <Set path="/fetch_counter" value="1" />
        <Set path="/events_count" value="0" />
        <Set path="/total_events_count" value="0" />
        <Set path="/is_first_fetch" value="true" />
        <Initialize path="/time_format" value="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" />

        <!-- Initial fetch -->
        <Log type="INFO" message="[Atlassian-AuditLogs]: Running fetch number #${/fetch_counter} for Audit Logs..." />
        <CallEndpoint url="https://api.atlassian.com/admin/v1/orgs/${/orgID}/events-stream" method="GET" savePath="/audits_logs">
            <SSLConfiguration allowUntrustedServerCertificate="true" />
            <BearerAuthentication token="${/apiToken}" />
            <QueryParameter name="from" value="${/bookmark}"/>
            <QueryParameter name="limit" value="${/eventsPerFetch}"/>
            <QueryParameter name="order" value="ASC"/>
        </CallEndpoint>

        <!-- Handle Errors -->
        <If condition="/audits_logs/status_code != 200">
            <Log type="ERROR" message="[Atlassian-AuditLogs]: Error: ${/audits_logs/body}"/>
            <Abort reason="[Atlassian-AuditLogs] Atlassian abort reason: ${/audits_logs/body}" />
        </If>

        <Set path="/events_count" value="${/audits_logs/body/meta/total}" />
        <Set path="/total_events_count" value="${/total_events_count + /events_count}" />
        
        <If condition="${/events_count} > 0">
            <!-- Post Events to Qradar. -->
            <Log type="INFO" message="[Atlassian-AuditLogs]: Posting ${/events_count} events for fetch #${/fetch_counter}" />
            <PostEvents path="/audits_logs/body/data" source="${/identifier}" />
        </If>

        <Set path="/cursor" value="${/audits_logs/body/meta/next}" />
        
        <!-- Loop to handle pagination -->
        <While condition="not empty(/audits_logs/body/meta/next) and (/audits_logs/body/meta/total >= /audits_logs/body/meta/page_size)" >
            <Log type="INFO" message="[Atlassian-AuditLogs]: Running fetch number #${/fetch_counter} for Audit Logs..." />

            <CallEndpoint url="https://api.atlassian.com/admin/v1/orgs/${/orgID}/events-stream" method="GET" savePath="/audits_logs">
                <SSLConfiguration allowUntrustedServerCertificate="true" />
                <BearerAuthentication token="${/apiToken}" />
                <QueryParameter name="cursor" value="${/cursor}"/>
                <QueryParameter name="order" value="ASC"/>
                <QueryParameter name="limit" value="${/eventsPerFetch}"/>
            </CallEndpoint>

            <!-- Handle Errors -->
            <If condition="/audits_logs/status_code != 200">
                <Log type="ERROR" message="[Atlassian-AuditLogs]: Error: ${/audits_logs/body}"/>
                <Abort reason="[Atlassian-AuditLogs] Atlassian abort reason: ${/audits_logs/body}" />
            </If>

            <!-- Handle a successful response. -->         
            <Set path="/events_count" value="${/audits_logs/body/meta/total}" />

            <If condition="${/events_count} > 0">
                <Set path="/total_events_count" value="${/total_events_count + /events_count}" />
                <Set path="/cursor" value="${/audits_logs/body/meta/next}" />
                <Set path="/fetch_counter" value="${/fetch_counter + 1}" />
                
                <!-- Post Events to Qradar. -->
                <Log type="INFO" message="[Atlassian-AuditLogs]: Posting ${/events_count} events for fetch #${/fetch_counter}" />
                <PostEvents path="/audits_logs/body/data" source="${/identifier}" />
            </If>
            
        </While>
        
        <If condition="${/total_events_count} > 0">
            
            <!-- Update bookmark for the next run. -->
            <Set path="/bookmark" value="${/audits_logs/body/data[${/events_count - 1}]/attributes/time}" />
            <ParseDate pattern="${/time_format}" timeZone="${/timeZone}" date="${/bookmark}" savePath="/bookmark" />
            <Set path="/bookmark" value="${/bookmark + 1}" />
            
            <Log type="INFO" message="[Atlassian-AuditLogs]: Audit Logs collection completed. Total fetched audits: ${/total_events_count}." />
        </If>
        <Else>
            <Log type="INFO" message="[Atlassian-AuditLogs]: No new audit logs found." />
        </Else>
    </Actions>

    <Tests>
        <DNSResolutionTest host="api.Atlassian.com" />
        <TCPConnectionTest host="api.Atlassian.com" />
        <SSLHandshakeTest host="api.Atlassian.com" />
        <HTTPConnectionThroughProxyTest url="api.Atlassian.com" expectedResponseStatus="404" />
    </Tests>
</Workflow>
